<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interfaz de Bienvenida</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="/public/Css/chat_bot.css"> <!-- Asegúrate de tener este archivo con tu estilo -->
    <link rel="stylesheet" href="/public/Css/nav.css"> <!-- Asegúrate de tener este archivo con tu estilo -->
</head>

<body>
    <header>
        <div class="nav-wrapper"> <!-- Contenedor principal para la barra de navegación -->
            <div class="logo-container"> <!-- Contenedor para el logotipo y el texto del logotipo -->
                <img src="/public/imagenes/logo.png" width="50" height="50" alt="" class="icon"> <!-- Imagen del logotipo -->
                <span class="logo-text">FLORA-NET</span> <!-- Texto del logotipo -->
            </div>
            <nav>
                <input class="hidden" type="checkbox" id="menuToggle"> <!-- Checkbox oculto para alternar el menú de navegación en dispositivos móviles -->
                <label class="menu-btn" for="menuToggle"> <!-- Etiqueta que actúa como botón de menú, vinculada al checkbox -->
                    <div class="menu"></div> <!-- Línea superior del botón de menú -->
                    <div class="menu"></div> <!-- Línea central del botón de menú -->
                    <div class="menu"></div> <!-- Línea inferior del botón de menú -->
                </label>
                <div class="nav-container"> <!-- Contenedor de navegación, visible en pantallas pequeñas -->
                    <ul class="nav-tabs">
                        <li class="nav-tab"><a href="start.html">Inicio</a></li>
                        <li class="nav-tab"><a href="prediccion.html">Predicción</a></li>
                        <li class="nav-tab"><a href="regar.html">Regar</a></li>
                        <li class="nav-tab"><a href="automatizar.html">Automatizar</a></li>
                        <li class="nav-tab"><a href="contact.html">Contactamos</a></li>
                        <li class="nav-tab"><a href="index.html">Cerrar Sesión</a></li>
                    </ul>
                </div>
            </nav>
        </div>
    </header>
    
    <main>
        <h1 id="welcomeMessage"></h1>
        <p>¿En qué puedo ayudarte hoy?</p>
        <div class="consulta-container">
            <div class="historial">
                <h3>Historial de Búsqueda</h3>
                <ul id="historialBusqueda">
                    <!-- Aquí se agregarán los elementos del historial de búsqueda -->
                </ul>
            </div>
            <div class="resultado">
                <h3>Resultado de la Consulta</h3>
                <pre id="resultadoConsulta"></pre> <!-- Muestra los resultados de la consulta -->
            </div>
        </div>

        <section class="buttons">
            <button id="button1" data-question="¿Cada Cuándo la debo regar?">
                <i class="fas fa-lightbulb"></i>
                ¿Cada Cuándo la debo regar?
            </button>
            <button id="button2" data-question="Flores más bonitas del mundo">
                <i class="fas fa-lightbulb"></i>
                Flores más bonitas del mundo
            </button>
            <button id="button3" data-question="Significado de las flores">
                <i class="fas fa-lightbulb"></i>
                Significado de las flores
            </button>
            <button id="button4" data-question="¿Qué tipo de flores debo regalar dependiendo la situación?">
                <i class="fas fa-lightbulb"></i>
                ¿Qué tipo de flores debo regalar dependiendo la situación?
            </button>
        </section>
    </main>

    <section class="error-message" style="display: none;">
        <p id="errorConsulta">Hubo un error. Por favor, inténtalo de nuevo más tarde.</p>
    </section>

    <section>
        <div class="input-container">
            <textarea id="consulta" placeholder="Ingresa una instrucción aquí"></textarea>
            <button class="send-btn" id="botonConsulta"><i class="fas fa-paper-plane"></i> Enviar</button>
        </div>
    </section>

    <footer>
        <p>Revisores humanos analizan algunos chats guardados para mejorar la IA de Google. Para evitar esto puedes optar por futuras inhabilitaciones...</p>
    </footer>

    <script type="importmap">
        {
            "imports": {
                "@google/generative-ai": "https://esm.run/@google/generative-ai"
            }
        }
    </script>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        const clave = ""; // Inserta tu clave API aquí
        const genAI = new GoogleGenerativeAI(clave);
        const model = genAI.getGenerativeModel({ model: "gemini-pro" });

        // Función para manejar la consulta al chatbot, reutilizable por cualquier botón
        async function realizarConsulta(consulta) {
            const resultadoConsulta = document.querySelector("#resultadoConsulta");
            const errorConsulta = document.querySelector("#errorConsulta");
            const errorSection = document.querySelector(".error-message");

            desactivarBoton();

            try {
                const result = await model.generateContent(consulta);
                const response = await result.response;
                const text = await response.text();

                resultadoConsulta.innerHTML = formatearTexto(text);
                document.querySelector("#consulta").value = ''; // Limpia el contenido del textarea después de recibir la respuesta
            } catch (error) {
                resultadoConsulta.innerHTML = '';
                errorConsulta.textContent = 'Hubo un problema con la consulta. Por favor, inténtalo de nuevo más tarde.';
                errorSection.style.display = 'block';

                document.querySelector("#consulta").value = '';

                setTimeout(() => {
                    errorSection.style.display = 'none';
                }, 4000);

                console.error("Error al realizar la consulta:", error);
            } finally {
                activarBoton();
            }
        }

        // Añadir eventos de clic a los botones de opciones predefinidas
        document.querySelector("#button1").addEventListener("click", () => {
            const consulta = document.querySelector("#button1").getAttribute("data-question");
            realizarConsulta(consulta);
        });

        document.querySelector("#button2").addEventListener("click", () => {
            const consulta = document.querySelector("#button2").getAttribute("data-question");
            realizarConsulta(consulta);
        });

        document.querySelector("#button3").addEventListener("click", () => {
            const consulta = document.querySelector("#button3").getAttribute("data-question");
            realizarConsulta(consulta);
        });

        document.querySelector("#button4").addEventListener("click", () => {
            const consulta = document.querySelector("#button4").getAttribute("data-question");
            realizarConsulta(consulta);
        });

        // Manejador para el botón de consulta principal
        document.querySelector("#botonConsulta").addEventListener("click", () => {
            const consulta = document.querySelector("#consulta").value;
            realizarConsulta(consulta);
        });

        // Función para desactivar el botón de consulta y mostrar el estado de "Consultando..."
        function desactivarBoton() {
            const botonConsulta = document.querySelector("#botonConsulta");
            botonConsulta.disabled = true;
            botonConsulta.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Consultando...';
        }

        // Función para activar el botón de consulta y volver a su estado normal
        function activarBoton() {
            const botonConsulta = document.querySelector("#botonConsulta");
            botonConsulta.disabled = false;
            botonConsulta.innerHTML = '<i class="fas fa-paper-plane"></i> Enviar';
        }

        // Función para formatear el texto reemplazando los asteriscos con negritas HTML
        function formatearTexto(texto) {
            return texto.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        }

        // Función para extraer el parámetro 'flor' de la URL y establecerlo en el textarea
        function setConsultaFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const flor = urlParams.get('flor');
            if (flor) {
                document.querySelector("#consulta").value = `Información sobre ${flor}`;
                document.querySelector("#botonConsulta").click();
            }
        }

        // Configuración inicial al cargar la página
        window.addEventListener('DOMContentLoaded', () => {
            setConsultaFromURL();

            const userName = localStorage.getItem('userName');
            if (userName) {
                const welcomeMessage = document.getElementById('welcomeMessage');
                welcomeMessage.textContent = `Hola, ${userName}`;
                welcomeMessage.style.fontSize = '2.5em';
            }
        });
    </script>
</body>

</html>
